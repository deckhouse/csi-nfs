From d4b9e8fc2d30a3ed81e3f7d6b8835d134cdc9322 Mon Sep 17 00:00:00 2001
From: Aleksandr Zimin <alexandr.zimin@flant.com>
Date: Fri, 14 Feb 2025 10:33:38 +0300
Subject: [PATCH] add volume cleanup

Signed-off-by: Aleksandr Zimin <alexandr.zimin@flant.com>
---
 pkg/nfs/controllerserver.go | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/pkg/nfs/controllerserver.go b/pkg/nfs/controllerserver.go
index d8af15da..a5439430 100644
--- a/pkg/nfs/controllerserver.go
+++ b/pkg/nfs/controllerserver.go
@@ -258,6 +258,18 @@ func (cs *ControllerServer) DeleteVolume(ctx context.Context, req *csi.DeleteVol
 				return nil, status.Errorf(codes.Internal, "archive subdirectory(%s, %s) failed with %v", internalVolumePath, archivedInternalVolumePath, err.Error())
 			}
 		} else {
+			volumeCleanupMethod, volumeCleanupEnabled, err := getVolumeCleanupMethod(req.GetSecrets())
+			if err != nil {
+				return nil, status.Errorf(codes.Internal, "failed to get volume cleanup method: %v", err.Error())
+			}
+
+			if volumeCleanupEnabled {
+				err = cleanupVolume(internalVolumePath, volumeCleanupMethod)
+				if err != nil {
+					return nil, status.Errorf(codes.Internal, "Volume cleanup failed with %v", err.Error())
+				}
+			}
+
 			// delete subdirectory under base-dir
 			klog.V(2).Infof("removing subdirectory at %v", internalVolumePath)
 			if err = os.RemoveAll(internalVolumePath); err != nil {
@@ -424,6 +436,19 @@ func (cs *ControllerServer) DeleteSnapshot(ctx context.Context, req *csi.DeleteS
 
 	// delete snapshot archive
 	internalVolumePath := getInternalVolumePath(cs.Driver.workingMountDir, vol)
+
+	volumeCleanupMethod, volumeCleanupEnabled, err := getVolumeCleanupMethod(req.GetSecrets())
+	if err != nil {
+		return nil, status.Errorf(codes.Internal, "failed to get volume cleanup method: %v", err.Error())
+	}
+
+	if volumeCleanupEnabled {
+		err = cleanupVolume(internalVolumePath, volumeCleanupMethod)
+		if err != nil {
+			return nil, status.Errorf(codes.Internal, "Volume cleanup failed with %v", err.Error())
+		}
+	}
+
 	klog.V(2).Infof("Removing snapshot archive at %v", internalVolumePath)
 	if err = os.RemoveAll(internalVolumePath); err != nil {
 		return nil, status.Errorf(codes.Internal, "failed to delete subdirectory: %v", err.Error())
-- 
2.39.5 (Apple Git-154)

