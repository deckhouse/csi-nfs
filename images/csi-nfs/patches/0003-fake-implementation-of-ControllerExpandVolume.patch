From 2788d323ac8c5077432e80d4c50f0898bd82f59d Mon Sep 17 00:00:00 2001
From: Alexandr Stefurishin <alexandr.stefurishin@flant.com>
Date: Mon, 23 Sep 2024 17:40:34 +0300
Subject: [PATCH] fake implementation of ControllerExpandVolume

Signed-off-by: Alexandr Stefurishin <alexandr.stefurishin@flant.com>
---
 pkg/nfs/controllerserver.go | 19 ++++++++++++++++---
 pkg/nfs/nfs.go              |  2 ++
 2 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/pkg/nfs/controllerserver.go b/pkg/nfs/controllerserver.go
index 726df875..664ce571 100644
--- a/pkg/nfs/controllerserver.go
+++ b/pkg/nfs/controllerserver.go
@@ -304,7 +304,11 @@ func (cs *ControllerServer) ListVolumes(_ context.Context, _ *csi.ListVolumesReq
 }
 
 func (cs *ControllerServer) GetCapacity(_ context.Context, _ *csi.GetCapacityRequest) (*csi.GetCapacityResponse, error) {
-	return nil, status.Error(codes.Unimplemented, "")
+	return &csi.GetCapacityResponse{
+		AvailableCapacity: 1000_000_000_000_000, // 1000 TB
+		MaximumVolumeSize: nil,
+		MinimumVolumeSize: nil,
+	}, nil
 }
 
 // ControllerGetCapabilities implements the default GRPC callout.
@@ -432,8 +436,17 @@ func (cs *ControllerServer) ListSnapshots(_ context.Context, _ *csi.ListSnapshot
 	return nil, status.Error(codes.Unimplemented, "")
 }
 
-func (cs *ControllerServer) ControllerExpandVolume(_ context.Context, _ *csi.ControllerExpandVolumeRequest) (*csi.ControllerExpandVolumeResponse, error) {
-	return nil, status.Error(codes.Unimplemented, "")
+func (cs *ControllerServer) ControllerExpandVolume(ctx context.Context, req *csi.ControllerExpandVolumeRequest) (*csi.ControllerExpandVolumeResponse, error) {
+	// fake implementation, doesn't really resize anything
+
+	klog.V(2).Infof("received expansion request for volumeID:%s, requiredBytes: %d", req.VolumeId, req.CapacityRange.RequiredBytes)
+	klog.Warning("volume expansion is not really happenning, fake implementation is used")
+
+	// TODO: check that requested capacity is not lower then the current one
+	return &csi.ControllerExpandVolumeResponse{
+		CapacityBytes:         req.CapacityRange.RequiredBytes,
+		NodeExpansionRequired: false,
+	}, nil
 }
 
 // Mount nfs server at base-dir
diff --git a/pkg/nfs/nfs.go b/pkg/nfs/nfs.go
index 7d69265e..e91093da 100644
--- a/pkg/nfs/nfs.go
+++ b/pkg/nfs/nfs.go
@@ -98,6 +98,8 @@ func NewDriver(options *DriverOptions) *Driver {
 		csi.ControllerServiceCapability_RPC_SINGLE_NODE_MULTI_WRITER,
 		csi.ControllerServiceCapability_RPC_CLONE_VOLUME,
 		csi.ControllerServiceCapability_RPC_CREATE_DELETE_SNAPSHOT,
+		csi.ControllerServiceCapability_RPC_GET_CAPACITY,
+		csi.ControllerServiceCapability_RPC_EXPAND_VOLUME,
 	})
 
 	n.AddNodeServiceCapabilities([]csi.NodeServiceCapability_RPC_Type{
-- 
2.43.0

