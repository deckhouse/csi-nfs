From a0559518013f75a873ba616a3cdee597a1b59135 Mon Sep 17 00:00:00 2001
From: Alexandr Stefurishin <alexandr.stefurishin@flant.com>
Date: Tue, 24 Sep 2024 09:56:28 +0300
Subject: [PATCH] fake-implementation-of-ControllerExpandVolume

Signed-off-by: Alexandr Stefurishin <alexandr.stefurishin@flant.com>
---
 pkg/nfs/controllerserver.go | 18 +++++++++++++++---
 pkg/nfs/identityserver.go   | 14 ++++++++++++++
 pkg/nfs/nfs.go              |  3 +++
 pkg/nfs/nodeserver.go       | 12 ++++++++++--
 4 files changed, 42 insertions(+), 5 deletions(-)

diff --git a/pkg/nfs/controllerserver.go b/pkg/nfs/controllerserver.go
index 726df875..494567de 100644
--- a/pkg/nfs/controllerserver.go
+++ b/pkg/nfs/controllerserver.go
@@ -304,7 +304,11 @@ func (cs *ControllerServer) ListVolumes(_ context.Context, _ *csi.ListVolumesReq
 }
 
 func (cs *ControllerServer) GetCapacity(_ context.Context, _ *csi.GetCapacityRequest) (*csi.GetCapacityResponse, error) {
-	return nil, status.Error(codes.Unimplemented, "")
+	return &csi.GetCapacityResponse{
+		AvailableCapacity: 1000_000_000_000_000, // 1000 TB
+		MaximumVolumeSize: nil,
+		MinimumVolumeSize: nil,
+	}, nil
 }
 
 // ControllerGetCapabilities implements the default GRPC callout.
@@ -432,8 +436,16 @@ func (cs *ControllerServer) ListSnapshots(_ context.Context, _ *csi.ListSnapshot
 	return nil, status.Error(codes.Unimplemented, "")
 }
 
-func (cs *ControllerServer) ControllerExpandVolume(_ context.Context, _ *csi.ControllerExpandVolumeRequest) (*csi.ControllerExpandVolumeResponse, error) {
-	return nil, status.Error(codes.Unimplemented, "")
+func (cs *ControllerServer) ControllerExpandVolume(_ context.Context, req *csi.ControllerExpandVolumeRequest) (*csi.ControllerExpandVolumeResponse, error) {
+	// fake implementation, doesn't really resize anything
+
+	klog.V(2).Infof("[ControllerExpandVolume] received expansion request for volumeID:%s, requiredBytes: %d", req.VolumeId, req.CapacityRange.RequiredBytes)
+	klog.Warning("[ControllerExpandVolume] volume expansion is not really happenning, fake implementation is used")
+
+	return &csi.ControllerExpandVolumeResponse{
+		CapacityBytes:         req.CapacityRange.RequiredBytes,
+		NodeExpansionRequired: false,
+	}, nil
 }
 
 // Mount nfs server at base-dir
diff --git a/pkg/nfs/identityserver.go b/pkg/nfs/identityserver.go
index d76fcf49..85afdb6f 100644
--- a/pkg/nfs/identityserver.go
+++ b/pkg/nfs/identityserver.go
@@ -61,6 +61,20 @@ func (ids *IdentityServer) GetPluginCapabilities(_ context.Context, _ *csi.GetPl
 					},
 				},
 			},
+			{
+				Type: &csi.PluginCapability_VolumeExpansion_{
+					VolumeExpansion: &csi.PluginCapability_VolumeExpansion{
+						Type: csi.PluginCapability_VolumeExpansion_ONLINE,
+					},
+				},
+			},
+			{
+				Type: &csi.PluginCapability_VolumeExpansion_{
+					VolumeExpansion: &csi.PluginCapability_VolumeExpansion{
+						Type: csi.PluginCapability_VolumeExpansion_OFFLINE,
+					},
+				},
+			},
 		},
 	}, nil
 }
diff --git a/pkg/nfs/nfs.go b/pkg/nfs/nfs.go
index 7d69265e..b57f8d83 100644
--- a/pkg/nfs/nfs.go
+++ b/pkg/nfs/nfs.go
@@ -98,12 +98,15 @@ func NewDriver(options *DriverOptions) *Driver {
 		csi.ControllerServiceCapability_RPC_SINGLE_NODE_MULTI_WRITER,
 		csi.ControllerServiceCapability_RPC_CLONE_VOLUME,
 		csi.ControllerServiceCapability_RPC_CREATE_DELETE_SNAPSHOT,
+		csi.ControllerServiceCapability_RPC_GET_CAPACITY,
+		csi.ControllerServiceCapability_RPC_EXPAND_VOLUME,
 	})
 
 	n.AddNodeServiceCapabilities([]csi.NodeServiceCapability_RPC_Type{
 		csi.NodeServiceCapability_RPC_GET_VOLUME_STATS,
 		csi.NodeServiceCapability_RPC_SINGLE_NODE_MULTI_WRITER,
 		csi.NodeServiceCapability_RPC_UNKNOWN,
+		csi.NodeServiceCapability_RPC_EXPAND_VOLUME,
 	})
 	n.volumeLocks = NewVolumeLocks()
 
diff --git a/pkg/nfs/nodeserver.go b/pkg/nfs/nodeserver.go
index 76e0d675..c4667a43 100644
--- a/pkg/nfs/nodeserver.go
+++ b/pkg/nfs/nodeserver.go
@@ -292,8 +292,16 @@ func (ns *NodeServer) NodeStageVolume(_ context.Context, _ *csi.NodeStageVolumeR
 }
 
 // NodeExpandVolume node expand volume
-func (ns *NodeServer) NodeExpandVolume(_ context.Context, _ *csi.NodeExpandVolumeRequest) (*csi.NodeExpandVolumeResponse, error) {
-	return nil, status.Error(codes.Unimplemented, "")
+func (ns *NodeServer) NodeExpandVolume(_ context.Context, req *csi.NodeExpandVolumeRequest) (*csi.NodeExpandVolumeResponse, error) {
+	klog.V(2).Infof(
+		"[NodeExpandVolume] received expansion request for volumeID:%s, path: %s, requiredBytes: %d",
+		req.VolumeId,
+		req.VolumePath,
+		req.CapacityRange.RequiredBytes,
+	)
+	klog.Warning("[NodeExpandVolume] volume expansion is not really happenning, fake implementation is used")
+
+	return &csi.NodeExpandVolumeResponse{}, nil
 }
 
 func makeDir(pathname string) error {
-- 
2.43.0

